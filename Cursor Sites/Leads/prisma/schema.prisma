// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Lead {
  id                String   @id @default(uuid())
  nom               String
  prenom            String
  email             String
  telephone         String?
  secteur           String   // IMMOBILIER, ASSURANCE, BANQUE_PRET, MARCHE_FINANCIER, GESTION_PATRIMOINE, INVESTISSEMENT_FINANCIER, COURTAGE_ASSURANCE, CONSEIL_FINANCIER, CREDIT_CONSOMMATION, CREDIT_IMMOBILIER, CREDIT_PROFESSIONNEL, ASSURANCE_VIE, ASSURANCE_HABITATION, ASSURANCE_AUTO, ASSURANCE_SANTE, SCPI, PERP, PEA, ASSURANCE_VL, INVESTISSEMENT_LOCATIF, DEFISCALISATION, RETRAITE, EPARGNE, TRADING, CRYPTO, ENTREPRENEURIAT, FORMATION_FINANCIERE, CONSEIL_EN_PATRIMOINE, MANDAT_MANAGEMENT, FISCALITE, SUCCESSION, DONATION, SCI, LMNP, PINEL, DEFICIT_FONCIER, AUTRE
  statut            String   @default("NOUVEAU") // NOUVEAU, CONTACTE, CONVERTI, PERDU
  source            String?
  notes             String?
  entreprise        String?
  
  // Champs spécifiques par secteur
  budget            Float?   // Pour immobilier
  typeBien          String?  // Pour immobilier (appartement, maison, etc.)
  typeCredit        String?  // Pour banque (immobilier, consommation, professionnel)
  montantCredit     Float?   // Pour banque
  typeAssurance     String?  // Pour assurance (vie, habitation, auto)
  produitFinancier  String?  // Pour marché financier
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  articlesGeneres   Article[]

  @@index([secteur])
  @@index([statut])
  @@index([email])
}

model ComparateurPret {
  id                String   @id @default(uuid())
  nom               String   // Nom du comparateur (Pretto, Meilleur Taux, etc.)
  type              String   // INTERNE, PRETTO, MEILLEUR_TAUX, MEILLEUR_AGENTS, AUTRE
  url               String?  // URL de l'API ou du site
  apiKey            String?  // Clé API si nécessaire
  actif             Boolean  @default(true)
  description       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  offres            OffrePret[]

  @@index([type])
  @@index([actif])
}

model OffrePret {
  id                String   @id @default(uuid())
  comparateurId     String
  comparateur       ComparateurPret @relation(fields: [comparateurId], references: [id], onDelete: Cascade)
  
  // Informations de l'offre
  nomBanque         String
  nomProduit        String
  typeCredit        String   // immobilier, consommation, professionnel
  
  // Caractéristiques du prêt
  montantMin        Float
  montantMax        Float
  dureeMin          Int      // En mois
  dureeMax          Int      // En mois
  tauxNominal       Float    // Taux nominal annuel (%)
  tauxEffectif      Float    // TAEG (%)
  apportMin         Float?   // Apport minimum requis (%)
  
  // Frais
  fraisDossier      Float?   // Frais de dossier
  fraisGarantie     Float?   // Frais de garantie
  assuranceObli     Boolean  @default(false)
  montantAssurance  Float?   // Montant mensuel assurance
  
  // Conditions
  conditions        String?  // Conditions particulières
  avantages         String?  // Avantages de l'offre
  delaiTraitement   Int?     // Délai de traitement en jours
  
  // Statut
  disponible        Boolean  @default(true)
  dateExpiration    DateTime?
  
  // Métadonnées
  score             Float?   // Score de qualité (0-100)
  nombreDemandes    Int      @default(0)
  tauxAcceptation   Float?   // Taux d'acceptation (%)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([comparateurId])
  @@index([typeCredit])
  @@index([disponible])
  @@index([tauxEffectif])
}

model ComparaisonPret {
  id                String   @id @default(uuid())
  leadId            String?  // Lien vers un lead si applicable
  
  // Critères de recherche
  montant           Float
  duree             Int      // En mois
  typeCredit        String
  apport            Float?    // Apport (%)
  revenus           Float?   // Revenus mensuels
  
  // Résultats
  offresIds         String   // JSON array des IDs d'offres comparées
  meilleureOffreId  String?  // ID de la meilleure offre
  
  createdAt         DateTime @default(now())

  @@index([leadId])
  @@index([typeCredit])
}

model Article {
  id                String   @id @default(uuid())
  titre             String
  slug              String   @unique
  contenu           String   // Contenu HTML/Markdown
  resume            String   // Résumé pour les listes
  categorie         String   // CREDIT_IMMOBILIER, ASSURANCE, etc.
  tags              String   // JSON array de tags
  auteur            String?  // Nom de l'auteur ou "Système"
  source            String   // AUTO_GENERATED, MANUAL, USER_DATA
  sourceData        String?  // JSON avec données source (leadId, comparaisonId, etc.)
  imageUrl          String?
  vue               Int      @default(0)
  likes             Int      @default(0)
  published         Boolean  @default(true)
  publishedAt       DateTime?
  seoTitle          String?
  seoDescription    String?
  keywords          String?  // Mots-clés SEO
  leadId            String?  // Lien vers le lead qui a généré l'article
  lead              Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([categorie])
  @@index([source])
  @@index([published])
  @@index([slug])
  @@index([leadId])
}

model AvisBanque {
  id          String   @id @default(uuid())
  banque      String
  note        Int      // 1-5
  commentaire String?
  auteur      String?
  email       String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([banque])
  @@index([note])
  @@index([verified])
}

model DossierPret {
  id                String   @id @default(uuid())
  identifiant       String   @unique
  
  // Responsable de dossier
  gestionnaireDossier Boolean @default(true)
  
  // Le Projet
  typePret          String
  montantSouhaite   Float
  dureeSouhaitee    Int      // En années
  apportPersonnel   Float?
  finalite          String?
  natureBien        String?
  travaux           Boolean  @default(false)
  
  // Emprunteur
  emprunteurCivilite String
  emprunteurNom     String
  emprunteurPrenom   String
  emprunteurDateNaissance DateTime?
  emprunteurLieuNaissance String?
  emprunteurNationalite String?
  emprunteurSituationFamiliale String?
  emprunteurNombreEnfants Int @default(0)
  emprunteurAdresse String?
  emprunteurCodePostal String?
  emprunteurVille   String?
  emprunteurPays    String?
  emprunteurEmail   String
  emprunteurTelephone String?
  
  // Co-emprunteur (JSON pour flexibilité)
  coEmprunteurData  String?  // JSON avec toutes les données co-emprunteur
  
  // Situation de famille
  situationFamiliale String?
  nomConjoint       String?
  prenomConjoint    String?
  dateNaissanceConjoint DateTime?
  regimeMatrimonial String?
  enfantsCharge     Boolean  @default(false)
  agesEnfants       String?  // JSON array
  situationFiscale String?
  nombrePartsFiscales Float?
  revenusMensuelsFoyer Float?
  
  // Logement
  statutLogement    String?
  loyerMensuel      Float?
  adresseLogement   String?
  codePostalLogement String?
  villeLogement     String?
  typeLogement      String?
  usageLogement     String?
  depuisQuandLogement String?
  
  // Situation professionnelle (JSON pour emprunteur et co-emprunteur)
  emprunteurSituationPro String? // JSON
  coEmprunteurSituationPro String? // JSON
  
  // Banque
  nomBanque         String?
  numeroCompte      String?
  depuisQuandBanque String?
  statutCompte      String?
  montantDecouvert  Float?
  
  // Revenus et charges (JSON arrays)
  revenus           String?  // JSON array
  charges           String?  // JSON array
  
  // Simulation
  capaciteEmprunt   Float?
  mensualiteMax     Float?
  tauxEndettement   Float?
  resteAVivre       Float?
  mensualiteEstimee Float?
  tauxPropose       Float?
  coutTotal         Float?
  
  // Informations complémentaires
  informationsComplementaires String?
  commentaires      String?  // JSON array
  
  // Statut du dossier
  statut            String   @default("BROUILLON") // BROUILLON, EN_COURS, VALIDE, REFUSE, ACCEPTE
  leadId            String?  // Lien vers le lead généré
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([identifiant])
  @@index([emprunteurEmail])
  @@index([statut])
  @@index([typePret])
  @@index([leadId])
}

model FacebookPage {
  id                String   @id @default(uuid())
  pageId            String   @unique // ID de la page Facebook
  pageName          String
  accessToken       String   // Token d'accès Facebook
  category          String?  // Catégorie de la page
  followers         Int      @default(0)
  active            Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  posts             FacebookPost[]
  
  @@index([pageId])
  @@index([active])
}

model FacebookPost {
  id                String   @id @default(uuid())
  pageId            String
  page              FacebookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  facebookPostId    String?  @unique // ID du post sur Facebook
  articleId         String?  // Lien vers l'article du site
  message           String   // Message du post
  link              String?  // Lien partagé
  imageUrl          String?  // Image du post
  
  // Métriques Facebook
  likes             Int      @default(0)
  comments          Int      @default(0)
  shares            Int      @default(0)
  reach             Int      @default(0)
  impressions       Int      @default(0)
  
  // Statut
  published         Boolean  @default(false)
  scheduledAt       DateTime? // Date de publication programmée
  publishedAt       DateTime? // Date de publication réelle
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([pageId])
  @@index([facebookPostId])
  @@index([published])
  @@index([articleId])
}

model FacebookLead {
  id                String   @id @default(uuid())
  leadFormId        String?  // ID du formulaire de lead Facebook
  facebookLeadId    String   @unique // ID du lead sur Facebook
  
  // Données du lead
  nom               String?
  prenom            String?
  email             String?
  telephone         String?
  adresse           String?
  ville             String?
  codePostal        String?
  
  // Métadonnées
  adId              String?  // ID de l'annonce qui a généré le lead
  adName            String?  // Nom de l'annonce
  formName          String?  // Nom du formulaire
  
  // Statut
  imported          Boolean  @default(false)
  leadId            String?  // ID du lead créé dans le système
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([facebookLeadId])
  @@index([imported])
  @@index([email])
}

model Visite {
  id                String   @id @default(uuid())
  sessionId         String   // ID de session unique pour éviter les doublons
  page              String   // Chemin de la page visitée
  referrer          String?  // Page d'origine
  userAgent         String?  // User agent du navigateur
  ip                String?  // Adresse IP (optionnel, pour statistiques)
  pays              String?  // Pays détecté (optionnel)
  ville             String?  // Ville détectée (optionnel)
  deviceType        String?  // mobile, desktop, tablet
  browser           String?  // Chrome, Firefox, Safari, etc.
  os                String?  // Windows, macOS, Linux, iOS, Android
  
  createdAt         DateTime @default(now())
  
  @@index([sessionId])
  @@index([page])
  @@index([createdAt])
  @@index([page, createdAt])
}
